<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Supabase demo ‚Äî Meldinger</title>

  <!-- Laster Bootstrap for enkel styling -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body{background:#f8fafc}
    .card-elev{border:1px solid #e9ecef;border-radius:1rem}
    .muted{color:#6c757d}
  </style>
</head>
<body>

  <!-- Toppfelt med tittel -->
  <nav class="navbar navbar-expand-md bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="#">Supabase demo</a>
    </div>
  </nav>

 <main class="container my-4">

  <!-- LOGIN-KORT -->
  <div id="auth-area" class="mb-4">
    <div class="card card-elev shadow-sm">
      <div class="card-body">
        <h2 class="h6 mb-3">Logg inn</h2>
        <p class="text-muted small mb-3">
          Du m√• logge inn med skole-epost (<code>@stud.akademiet.no</code>) for √• sende og se meldinger.
        </p>
        <form id="login-form" class="row g-2">
          <div class="col-12 col-md-4">
            <input id="login-email" type="email" class="form-control" placeholder="din@stud.akademiet.no" required>
          </div>
          <div class="col-12 col-md-4">
            <input id="login-password" type="password" class="form-control" placeholder="Passord" required>
          </div>
          <div class="col-12 col-md-4 d-flex gap-2">
            <button class="btn btn-primary flex-grow-1" type="submit">Logg inn / registrer</button>
            <button class="btn btn-outline-secondary" type="button" id="logout-btn">Logg ut</button>
          </div>
        </form>
        <p id="login-status" class="mt-2 small text-muted">Ikke innlogget.</p>
      </div>
    </div>
  </div>

  <!-- SELVE APPEN ‚Äì SKJULES TIL MAN ER LOGGET INN -->
  <div id="app-area" class="d-none">
    <header class="text-center mb-4">
      <h1 class="h4 fw-bold">Navn + kort melding</h1>
      <p class="text-muted mb-0">Skriver til databasen og viser under.</p>
    </header>

    <!-- Skjema for innsending av navn og melding -->
    <section class="row g-4">
      <div class="col-12 col-lg-5">
        <div class="card card-elev shadow-sm">
          <div class="card-body">
            <h2 class="h6 mb-3">Send inn</h2>
            <form id="form" class="needs-validation" novalidate>
              <div class="mb-3">
                <label class="form-label" for="name">Navn</label>
                <input id="name" class="form-control" minlength="2" maxlength="30" required placeholder="F.eks. Sara">
                <div class="invalid-feedback">Skriv inn navnet ditt (2‚Äì30 tegn).</div>
              </div>
              <div class="mb-3">
                <label class="form-label" for="content">Kort melding</label>
                <input id="content" class="form-control" maxlength="140" required placeholder="Hei verden! (maks 140 tegn)">
                <div class="invalid-feedback">Skriv en kort melding (maks 140 tegn).</div>
              </div>
              <button class="btn btn-primary w-100" type="submit">Lagre</button>
              <div id="status" class="form-text mt-2 muted">Klar</div>
            </form>
          </div>
        </div>
      </div>

      <!-- Omr√•de for √• vise alle meldinger -->
      <div class="col-12 col-lg-7">
        <div class="card card-elev shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h2 class="h6 mb-0">Meldinger</h2>
              <span class="badge text-bg-light"><span id="count">0</span> stk</span>
            </div>
            <div id="msgs" class="d-grid gap-2"></div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>


  <!-- Laster Supabase-biblioteket som gj√∏r det mulig √• kommunisere med databasen -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Her starter v√•rt eget JavaScript -->
<!-- Supabase-bibliotek -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Supabase-bibliotek -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Supabase-bibliotek -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // üîë Koble nettsiden til ditt Supabase-prosjekt
  const SUPABASE_URL = "https://aiseafkfjhixolxezjjq.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_mdoTv5Opu_0idPCaV64_6A_nIegPRg1";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const ALLOWED_DOMAIN = "@stud.akademiet.no";

  // Auth-UI
  const loginForm = document.getElementById('login-form');
  const loginEmailInput = document.getElementById('login-email');
  const loginPasswordInput = document.getElementById('login-password');
  const loginStatusEl = document.getElementById('login-status');
  const logoutBtn = document.getElementById('logout-btn');
  const appArea = document.getElementById('app-area');

  // Meldings-UI
  const form = document.getElementById('form');
  const nameInput = document.getElementById('name');
  const contentInput = document.getElementById('content');
  const msgsEl = document.getElementById('msgs');
  const statusEl = document.getElementById('status');
  const countEl = document.getElementById('count');

  // Holder p√• innlogget bruker
  let currentUser = null;

  // Gj√∏r tekst trygg for visning (hindrer HTML-injeksjon)
  function esc(s) {
    return (s || '').replace(/[<>&"']/g, c => ({
      '<': '&lt;',
      '>': '&gt;',
      '&': '&amp;',
      '"': '&quot;',
      "'": '&#39;',
    }[c]));
  }

  // Deler opp meldingen i navn og tekst
  function parseRow(r) {
    const raw = r.content || '';
    const i = raw.indexOf('::');
    return i === -1
      ? { name: 'Anonym', message: raw, created_at: r.created_at }
      : { name: raw.slice(0, i), message: raw.slice(i + 2), created_at: r.created_at };
  }

  // Leser meldinger fra databasen og viser dem
  async function loadMessages() {
    statusEl.textContent = 'Laster...';

    const { data, error } = await supabase
      .from('messages')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(100);

    if (error) {
      statusEl.textContent = 'Feil: ' + error.message;
      return;
    }

    countEl.textContent = (data || []).length;

    msgsEl.innerHTML = (data || []).map(r => {
      const it = parseRow(r);
      const when = new Date(it.created_at).toLocaleString();

      return `
        <div class="border rounded p-2">
          <div class="fw-semibold">${esc(it.name)}</div>
          <div>${esc(it.message)}</div>
          <div class="small text-muted">${when}</div>
        </div>
      `;
    }).join('');

    statusEl.textContent = 'Klar';
  }

  // Sjekk at e-post har riktig domene
  function hasAllowedDomain(email) {
    if (!email) return false;
    const clean = email.trim().toLowerCase();
    const domain = ALLOWED_DOMAIN.toLowerCase();
    return clean.endsWith(domain);
  }

  // Oppdater UI basert p√• om bruker er innlogget eller ikke
  function updateAuthUI() {
    if (currentUser && hasAllowedDomain(currentUser.email)) {
      appArea.classList.remove('d-none');
      loginStatusEl.textContent = 'Logget inn som ' + currentUser.email;
    } else {
      appArea.classList.add('d-none');
      loginStatusEl.textContent = 'Ikke innlogget. Logg inn med ' + ALLOWED_DOMAIN + '.';
    }
  }

  // Sjekk innlogging ved side-load
  async function ensureAuthOnLoad() {
    loginStatusEl.textContent = 'Sjekker innlogging...';

    const { data } = await supabase.auth.getUser();
    if (data?.user && hasAllowedDomain(data.user.email)) {
      currentUser = data.user;
      updateAuthUI();
      await loadMessages();
    } else {
      currentUser = null;
      await supabase.auth.signOut();
      updateAuthUI();
    }
  }

  // H√•ndter login-skjema
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    let email = loginEmailInput.value.trim().toLowerCase();
    const password = loginPasswordInput.value;

    if (!email || !password) {
      loginStatusEl.textContent = 'Skriv inn b√•de e-post og passord.';
      return;
    }

    if (!hasAllowedDomain(email)) {
      loginStatusEl.textContent = 'E-posten m√• slutte p√• ' + ALLOWED_DOMAIN + '.';
      return;
    }

    loginStatusEl.textContent = 'Logger inn...';

    // 1) Pr√∏v √• logge inn med e-post + passord
    let { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
      email,
      password
    });

    if (signInError) {
      // Hvis ingen bruker / feil passord -> pr√∏v √• lage bruker
      if (signInError.message.includes('Invalid login credentials')) {
        loginStatusEl.textContent = 'Fant ikke bruker, oppretter ny...';

        const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
          email,
          password
        });

        if (signUpError) {
          loginStatusEl.textContent = 'Feil ved oppretting av bruker: ' + signUpError.message;
          return;
        }

        currentUser = signUpData.user;
        updateAuthUI();
        loginStatusEl.textContent = 'Bruker opprettet og logget inn som ' + currentUser.email;
        form && (statusEl.textContent = 'Klar');
        await loadMessages();
        return;
      }

      // Andre feil
      loginStatusEl.textContent = 'Feil ved innlogging: ' + signInError.message;
      return;
    }

    // Innlogging ok
    currentUser = signInData.user;
    updateAuthUI();
    loginStatusEl.textContent = 'Logget inn som ' + currentUser.email;
    await loadMessages();
  });

  // Logg ut-knapp
  logoutBtn.addEventListener('click', async () => {
    await supabase.auth.signOut();
    currentUser = null;
    updateAuthUI();
    statusEl.textContent = 'Du er logget ut.';
  });

  // Sender inn ny melding n√•r eleven trykker "Lagre"
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    form.classList.add('was-validated');
    if (!form.checkValidity()) return;

    if (!currentUser || !currentUser.email || !hasAllowedDomain(currentUser.email)) {
      statusEl.textContent = 'Du m√• v√¶re logget inn med ' + ALLOWED_DOMAIN + ' for √• sende meldinger.';
      return;
    }

    const name = nameInput.value.trim();
    const msg = contentInput.value.trim();
    if (!name || !msg) return;

    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    statusEl.textContent = 'Lagrer...';

    const { error } = await supabase
      .from('messages')
      .insert({ content: name + '::' + msg });

    submitBtn.disabled = false;

    if (error) {
      statusEl.textContent = 'Feil ved lagring: ' + error.message;
      return;
    }

    form.reset();
    form.classList.remove('was-validated');
    statusEl.textContent = 'Lagret!';
    nameInput.focus();

    await loadMessages();
  });

  // Start: sjekk om noen er logget inn fra f√∏r
  ensureAuthOnLoad();
</script>





          </body>
          </html>