<!DOCTYPE html>
<html lang="no">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Supabase demo ‚Äî Meldinger</title>

    <!-- Laster Bootstrap for enkel styling -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #f8fafc;
      }
      .card-elev {
        border: 1px solid #e9ecef;
        border-radius: 1rem;
      }
      .muted {
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <!-- Toppfelt med tittel -->
    <nav class="navbar navbar-expand-md bg-white border-bottom">
      <div class="container">
        <a class="navbar-brand fw-semibold" href="#">Supabase demo</a>
        <!-- Role + user badges -->
        <div class="ms-auto d-flex align-items-center gap-2">
          <span
            id="role-badge"
            class="badge rounded-pill text-bg-secondary d-none"
            >Bruker</span
          >
          <span id="user-badge" class="badge rounded-pill text-bg-light"
            >Gjest</span
          >
        </div>
      </div>
    </nav>

    <main class="container my-4">
      <!-- LOGIN-KORT -->
      <div id="auth-area" class="mb-4">
        <div class="card card-elev shadow-sm">
          <div class="card-body">
            <h2 class="h6 mb-3">Logg inn</h2>
            <p class="text-muted small mb-3">
              Logg inn med e-post og passord. Bekreft e-posten via lenken du f√•r
              tilsendt.
            </p>

            <!-- Selve innloggingsskjemaet -->
            <form id="login-form" class="row g-2">
              <div class="col-12 col-md-4">
                <input
                  id="login-email"
                  type="email"
                  class="form-control"
                  placeholder="din@epost.no"
                  required
                />
              </div>
              <div class="col-12 col-md-4">
                <input
                  id="login-password"
                  type="password"
                  class="form-control"
                  placeholder="Passord"
                  required
                />
              </div>
              <div class="col-12 col-md-4 d-grid d-md-flex gap-2">
                <button class="btn btn-primary flex-grow-1" type="submit">
                  Logg inn / registrer
                </button>
              </div>
            </form>

            <!-- Status + logg ut -->
            <div class="d-flex justify-content-between align-items-center mt-3">
              <p id="login-status" class="small text-muted mb-0">
                Ikke innlogget.
              </p>
              <button
                class="btn btn-outline-secondary btn-sm d-none"
                type="button"
                id="logout-btn"
              >
                Logg ut
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- SELVE APPEN ‚Äì SKJULES TIL MAN ER LOGGET INN -->
      <div id="app-area" class="d-none">
        <header class="text-center mb-4">
          <h1 class="h4 fw-bold">Navn + kort melding</h1>
          <p class="text-muted mb-0">Skriver til databasen og viser under.</p>
        </header>

        <!-- ADMIN-OMR√ÖDE (vises kun for admin) -->
        <section id="admin-area" class="d-none mb-4">
          <div
            class="alert alert-warning d-flex justify-content-between align-items-center"
          >
            <div>
              <strong>Admin:</strong> Du er logget inn som admin. Her kan du
              gj√∏re admin-ting.
            </div>
            <div class="d-flex gap-2">
              <button id="refresh-btn" class="btn btn-sm btn-outline-dark">
                Oppdater meldinger
              </button>
              <!-- Eksempel: slett alle meldinger -->
              <button id="clear-btn" class="btn btn-sm btn-outline-danger">
                T√∏m meldinger
              </button>
            </div>
          </div>
        </section>

        <!-- Skjema for innsending av navn og melding -->
        <section class="row g-4">
          <div class="col-12 col-lg-5">
            <div class="card card-elev shadow-sm">
              <div class="card-body">
                <h2 class="h6 mb-3">Send inn</h2>
                <form id="form" class="needs-validation" novalidate>
                  <div class="mb-3">
                    <label class="form-label" for="name">Navn</label>
                    <!-- Navnet fylles automatisk ut og l√•ses etter f√∏rste gang -->
                    <input
                      id="name"
                      class="form-control bg-light"
                      minlength="2"
                      maxlength="30"
                      required
                      readonly
                    />
                    <div class="invalid-feedback">
                      Navnet ditt fylles inn automatisk etter innlogging.
                    </div>
                    <div class="form-text">
                      Navnet er knyttet til brukeren din og kan ikke endres her.
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label" for="content">Kort melding</label>
                    <input
                      id="content"
                      class="form-control"
                      maxlength="140"
                      required
                      placeholder="Hei verden! (maks 140 tegn)"
                    />
                    <div class="invalid-feedback">
                      Skriv en kortmelding (maks 140 tegn).
                    </div>
                  </div>
                  <button class="btn btn-primary w-100" type="submit">
                    Lagre
                  </button>
                  <div id="status" class="form-text mt-2 muted">Klar</div>
                </form>
              </div>
            </div>
          </div>

          <!-- Omr√•de for √• vise alle meldinger -->
          <div class="col-12 col-lg-7">
            <div class="card card-elev shadow-sm">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-2"
                >
                  <h2 class="h6 mb-0">Meldinger</h2>
                  <span class="badge text-bg-light"
                    ><span id="count">0</span> stk</span
                  >
                </div>
                <div id="msgs" class="d-grid gap-2"></div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- Laster Supabase-biblioteket -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Her starter v√•rt eget JavaScript -->
    <!-- Supabase-bibliotek -->
    <script>
      // üîë Koble nettsiden til ditt Supabase-prosjekt
      const SUPABASE_URL = "https://aiseafkfjhixolxezjjq.supabase.co";
      const SUPABASE_ANON_KEY =
        "sb_publishable_mdoTv5Opu_0idPCaV64_6A_nIegPRg1";
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // UI refs
      const adminArea = document.getElementById("admin-area");
      const refreshBtn = document.getElementById("refresh-btn");
      const clearBtn = document.getElementById("clear-btn");
      const userBadge = document.getElementById("user-badge");
      const roleBadge = document.getElementById("role-badge"); // ‚Üê NEW

      // Auth-UI
      const loginForm = document.getElementById("login-form");
      const loginEmailInput = document.getElementById("login-email");
      const loginPasswordInput = document.getElementById("login-password");
      const loginStatusEl = document.getElementById("login-status");
      const logoutBtn = document.getElementById("logout-btn");
      const appArea = document.getElementById("app-area");

      // Meldings-UI
      const form = document.getElementById("form");
      const nameInput = document.getElementById("name");
      const contentInput = document.getElementById("content");
      const msgsEl = document.getElementById("msgs");
      const statusEl = document.getElementById("status");
      const countEl = document.getElementById("count");

      // Holder p√• innlogget bruker + display-navn + rolle
      let currentUser = null;
      let displayName = null;
      let currentRole = "user"; // 'user' | 'admin'

      // NEW: shows current user in navbar
      function updateUserBadge() {
        if (currentUser?.email) {
          const isAdmin = currentRole === "admin";
          // email badge
          userBadge.textContent = currentUser.email;
          userBadge.className = "badge rounded-pill text-bg-secondary";
          // role badge
          roleBadge.textContent = isAdmin ? "Admin" : "Bruker";
          roleBadge.className =
            "badge rounded-pill " +
            (isAdmin ? "text-bg-warning" : "text-bg-secondary");
          roleBadge.classList.remove("d-none");
        } else {
          userBadge.textContent = "Gjest";
          userBadge.className = "badge rounded-pill text-bg-light";
          roleBadge.classList.add("d-none");
        }
      }

      // Gj√∏r tekst trygg for visning (hindrer HTML-injeksjon)
      function esc(s) {
        return (s || "").replace(
          /[<>&"']/g,
          (c) =>
            ({
              "<": "&lt;",
              ">": "&gt;",
              "&": "&amp;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }

      // Deler opp meldingen i navn og tekst
      function parseRow(r) {
        // Replace the "::" parser with explicit fields
        return {
          name: r.display_name || "Anonym",
          message: r.message || r.content || "",
          created_at: r.created_at,
        };
      }

      // Leser meldinger fra databasen og viser dem
      async function loadMessages() {
        statusEl.textContent = "Laster...";
        const { data, error } = await supabase
          .from("messages")
          .select("id, message, display_name, created_at")
          .order("created_at", { ascending: false })
          .limit(100);

        if (error) {
          statusEl.textContent = "Feil: " + error.message;
          return;
        }

        countEl.textContent = (data || []).length;

        msgsEl.innerHTML = (data || [])
          .map((r) => {
            const it = parseRow(r);
            const when = new Date(it.created_at).toLocaleString();

            return `
        <div class="border rounded p-2">
          <div class="fw-semibold">${esc(it.name)}</div>
          <div>${esc(it.message)}</div>
          <div class="small text-muted">${when}</div>
        </div>
      `;
          })
          .join("");

        statusEl.textContent = "Klar";
      }

      // S√∏rg for at brukeren har et display-navn lagret i metadata
      async function ensureDisplayName() {
        if (!currentUser) return;

        let metaName = currentUser.user_metadata?.display_name;
        if (
          metaName &&
          metaName.trim().length >= 2 &&
          metaName.trim().length <= 30
        ) {
          displayName = metaName.trim();
          nameInput.value = displayName;
          // Ensure profiles has a row with the name
          await supabase
            .from("profiles")
            .upsert(
              [
                {
                  id: currentUser.id,
                  email: currentUser.email,
                  display_name: displayName,
                },
              ],
              { onConflict: "id" }
            );
          return;
        }

        while (true) {
          const input = prompt(
            "Hva vil du hete n√•r du sender meldinger? (2‚Äì30 tegn)"
          );
          if (!input) {
            alert("Du m√• velge et navn for √• bruke tjenesten.");
            continue;
          }
          const trimmed = input.trim();
          if (trimmed.length < 2 || trimmed.length > 30) {
            alert("Navnet m√• v√¶re mellom 2 og 30 tegn.");
            continue;
          }

          const { data, error } = await supabase.auth.updateUser({
            data: { display_name: trimmed },
          });
          if (error) {
            alert("Kunne ikke lagre navnet: " + error.message);
            return;
          }

          // Save or create the profiles row with the name
          const { error: pErr } = await supabase
            .from("profiles")
            .upsert(
              [
                {
                  id: currentUser.id,
                  email: currentUser.email,
                  display_name: trimmed,
                },
              ],
              { onConflict: "id" }
            );
          if (pErr) {
            alert("Kunne ikke lagre navnet i profiles: " + pErr.message);
            return;
          }

          currentUser = data.user;
          displayName = trimmed;
          nameInput.value = displayName;
          break;
        }
      }

      // Hent profil/rolle for innlogget bruker
      async function loadProfileRole() {
        if (!currentUser) return;
        const { data, error } = await supabase
          .from("profiles")
          .select("role")
          .eq("id", currentUser.id)
          .single();

        if (error) {
          console.warn("Kunne ikke hente profilrolle:", error.message);
          currentRole = "user";
          updateUserBadge();
          return;
        }
        currentRole = data?.role || "user";
        updateUserBadge();
      }

      // UI basert p√• innlogging
      function updateAuthUI() {
        console.log("DEBUG user:", currentUser?.email);
        console.log("DEBUG role:", currentRole);
        updateUserBadge();
        if (currentUser) {
          appArea.classList.remove("d-none");
          loginForm.classList.add("d-none");
          logoutBtn.classList.remove("d-none");
          loginStatusEl.textContent =
            "Du er logget inn som " +
            currentUser.email +
            " ‚Äì rolle: " +
            (currentRole === "admin" ? "Admin" : "Bruker");

          if (currentRole === "admin") {
            adminArea.classList.remove("d-none");
          } else {
            adminArea.classList.add("d-none");
          }
        } else {
          appArea.classList.add("d-none");
          loginForm.classList.remove("d-none");
          logoutBtn.classList.add("d-none");
          loginStatusEl.textContent = "Ikke innlogget.";
          nameInput.value = "";
          displayName = null;
          currentRole = "user";
          adminArea.classList.add("d-none");
          updateUserBadge();
        }
      }

      // Sjekk innlogging ved side-load
      async function ensureAuthOnLoad() {
        loginStatusEl.textContent = "Sjekker innlogging...";

        const { data } = await supabase.auth.getUser();
        if (data?.user) {
          if (!data.user.confirmed_at) {
            loginStatusEl.textContent =
              "E-posten er ikke bekreftet. Sjekk e-posten din.";
            await supabase.auth.signOut();
            currentUser = null;
            updateAuthUI();
            return;
          }

          currentUser = data.user;
          updateUserBadge();
          await ensureDisplayName();
          await loadProfileRole();
          updateAuthUI();
          await loadMessages();
        } else {
          currentUser = null;
          await supabase.auth.signOut();
          updateAuthUI();
        }
      }

      // Listen to auth changes to keep the badge fresh
      supabase.auth.onAuthStateChange((_event, session) => {
        currentUser = session?.user ?? null;
        updateUserBadge(); // ‚Üê NEW
      });

      // H√•ndter login-skjema
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        let email = loginEmailInput.value.trim().toLowerCase();
        const password = loginPasswordInput.value;

        if (!email || !password) {
          loginStatusEl.textContent = "Skriv inn b√•de e-post og passord.";
          return;
        }

        loginStatusEl.textContent = "Logger inn...";

        // 1) Pr√∏v √• logge inn med e-post + passord
        let { data: signInData, error: signInError } =
          await supabase.auth.signInWithPassword({
            email,
            password,
          });

        if (signInError) {
          if (signInError.message.includes("Invalid login credentials")) {
            loginStatusEl.textContent =
              "Bruker finnes ikke ‚Äì oppretter ny og sender verifisering...";

            const { data: signUpData, error: signUpError } =
              await supabase.auth.signUp({
                email,
                password,
                options: {
                  emailRedirectTo: window.location.href,
                },
              });

            if (signUpError) {
              loginStatusEl.textContent =
                "Feil ved oppretting av bruker: " + signUpError.message;
              return;
            }

            loginStatusEl.textContent =
              "Bruker opprettet! Sjekk e-posten din for en bekreftelseslenke f√∏r du kan logge inn.";
            return;
          }

          loginStatusEl.textContent =
            "Innlogging feilet: " + signInError.message;
          return;
        }

        if (!signInData.user.confirmed_at) {
          loginStatusEl.textContent =
            "E-posten er ikke bekreftet enn√•. Sjekk innboksen din og klikk p√• lenken.";
          await supabase.auth.signOut();
          return;
        }

        currentUser = signInData.user;
        await ensureDisplayName();
        await loadProfileRole();
        updateAuthUI();
        await loadMessages();
      });

      // Logg ut-knapp
      logoutBtn.addEventListener("click", async () => {
        await supabase.auth.signOut();
        currentUser = null;
        updateAuthUI();
        statusEl.textContent = "Du er logget ut.";
      });

      // Sender inn ny melding
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        form.classList.add("was-validated");
        if (!form.checkValidity()) return;

        if (!currentUser || !currentUser.email) {
          statusEl.textContent = "Du m√• v√¶re logget inn for √• sende meldinger.";
          return;
        }

        if (!displayName) {
          await ensureDisplayName();
          if (!displayName) {
            statusEl.textContent = "Kunne ikke hente navnet ditt.";
            return;
          }
        }

        const msg = contentInput.value.trim();
        if (!msg) return;

        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        statusEl.textContent = "Lagrer...";

        // Include display_name so it‚Äôs not null
        const { error } = await supabase
          .from("messages")
          .insert({ message: msg, display_name: displayName });

        if (error) console.error("Insert failed", error);
        submitBtn.disabled = false;

        if (error) {
          statusEl.textContent = "Feil ved lagring: " + error.message;
          return;
        }

        form.classList.remove("was-validated");
        contentInput.value = "";
        statusEl.textContent = "Lagret!";
        contentInput.focus();

        await loadMessages();
      });

      // Admin-handlinger
      refreshBtn?.addEventListener("click", async () => {
        await loadMessages();
      });

      clearBtn?.addEventListener("click", async () => {
        if (currentRole !== "admin") return;
        if (!confirm("Er du sikker p√• at du vil slette alle meldinger?"))
          return;

        const { error } = await supabase.from("messages").delete().neq("id", 0);
        if (error) {
          alert("Feil ved sletting: " + error.message);
          return;
        }
        await loadMessages();
      });

      // Start: sjekk om noen er logget inn fra f√∏r
      ensureAuthOnLoad();
    </script>
  </body>
</html>
